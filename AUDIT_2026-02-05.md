# Smart Invoice Workflow — Full Audit

**Date:** 2026-02-05
**Auditor:** Claude (Super Manager)
**Verdict:** Working prototype, never deployed. Solid routing logic, significant gaps in test coverage and deployment readiness.

---

## What It Does

An automated invoice collection system for service businesses. The workflow:

1. Reads overdue invoices from a **Google Sheet** (the source of truth)
2. Calculates how many days each invoice is overdue
3. Determines which **escalation stage** to send (6 stages over 42 days)
4. Creates **Gmail drafts** (NOT auto-send) with templated, escalating reminders
5. Writes tracking data back to Google Sheets (last stage sent, date sent)
6. Human reviews drafts in Gmail and clicks Send

**Key design choice:** Drafts only, never auto-sends. Human stays in the loop.

---

## Architecture

```
Google Sheet (invoice data)
    ↓ read via Sheets API
scheduler.py (orchestrator)
    ├── router.py (stage logic: 7/14/21/28/35/42 days)
    ├── emailer.py (template rendering + Gmail API)
    └── sheets.py (read invoices, write-back tracking)
    ↓ output
Gmail Drafts (human reviews and sends)
```

### Source Files (7 files, ~450 lines of business logic)

| File | Lines | Purpose |
|------|-------|---------|
| `main.py` | 107 | CLI entry point (--dry-run, --verbose, --quiet) |
| `config.py` | 86 | Settings from env vars, business hours check, path config |
| `models.py` | 75 | `Invoice` and `DraftCreated` dataclasses |
| `router.py` | 132 | Stage routing: `days_overdue()`, `stage_for()`, `should_send()` |
| `emailer.py` | 197 | Gmail OAuth, template rendering, draft creation with retry |
| `sheets.py` | 288 | Google Sheets OAuth, read invoices, write-back tracking |
| `scheduler.py` | 274 | Orchestrator: `run_daily()`, `print_summary()` |

### Email Templates (6 files)

| Template | Tone |
|----------|------|
| `stage_07.txt` | Friendly check-in |
| `stage_14.txt` | Direct follow-up |
| `stage_21.txt` | More urgent |
| `stage_28.txt` | Firm, suggests phone call |
| `stage_35.txt` | Final before escalation |
| `stage_42.txt` | Last notice, mentions collections/legal |

### External Dependencies

| Service | Used By | Auth Method |
|---------|---------|-------------|
| Google Sheets API | `sheets.py` | OAuth2 (client_secret.json → token_sheets.json) |
| Gmail API | `emailer.py` | OAuth2 (client_secret.json → token_gmail.json) |

### Python Dependencies

| Package | Used | Notes |
|---------|------|-------|
| google-api-python-client | Yes | Sheets + Gmail API |
| google-auth / google-auth-oauthlib | Yes | OAuth2 flow |
| pandas | Yes | DataFrame processing in sheets.py |
| python-dotenv | Yes | .env loading |
| tabulate | Yes | Summary table in print_summary |
| **APScheduler** | **NO** | Listed but never imported |
| **rich** | **NO** | Listed but never imported |

---

## Test Results

```
41 passed in 2.65s
```

### What's Tested

| Test File | Count | Covers |
|-----------|-------|--------|
| `test_router.py` | 21 | `days_overdue`, `stage_for`, `should_send`, `get_next_stage`, `days_until_next_stage`, full escalation sequence |
| `test_templates.py` | 6 | Template rendering, placeholder substitution, invalid format detection, all stage templates exist |
| `test_error_tracking.py` | 14 | `ErrorType` enum, `ProcessingError` dataclass, grouping, severity |

### What's NOT Tested (Critical Gaps)

| Module | Why It Matters |
|--------|---------------|
| `sheets.py` | Reads/writes actual invoice data — the core data pipeline |
| `emailer.py` | Creates Gmail drafts — the core output |
| `scheduler.py` (`run_daily`) | The orchestrator — ties everything together |
| `config.py` | Settings validation, business hours logic |

**The tested code is correct. The untested code is the critical path.**

Router logic (tested) is pure functions with no external dependencies — easy to test, easy to trust. The Google API integration (untested) is where real failures will happen: auth expiry, schema mismatches, rate limits, malformed sheet data.

---

## Deployment State

| Check | Status |
|-------|--------|
| `.env` file exists | **NO** — only `.env.example` |
| `client_secret.json` (Google OAuth) | **NO** |
| `token_sheets.json` (Sheets auth) | **NO** |
| `token_gmail.json` (Gmail auth) | **NO** |
| Cron job configured | **NO** |
| Ever run against real data | **NO** |
| Docker deployed | **NO** |

**This has never been deployed or run with real data.**

---

## Build System Issue

`pyproject.toml` specifies:
```toml
build-backend = "setuptools.build_backend"
```

This is wrong. The correct value is `setuptools.build_meta`. This causes `uv run pytest` to fail. Tests can only be run via `.venv/bin/python -m pytest` as a workaround.

---

## Git History

9 commits, 2 merged PRs. Last activity Jan 27 (scaffolding restructure).

```
a6e5cd1 refactor: reorganize project structure and add agent infrastructure
6614923 Merge pull request #2 (sales strategy)
2ded47c Add error type enum and comprehensive error tracking improvements
d849b97 Eliminate silent failures and improve error visibility
e2193a2 Fix critical bugs and add rate limiting
c3eae65 Add complete Python implementation
876c92b Add README.md
c3f59fb Initial commit
```

---

## Issues Found

### P1 — Must Fix

1. **Build system broken** — `pyproject.toml` has wrong build-backend (`setuptools.build_backend` → should be `setuptools.build_meta`)
2. **Zero test coverage on critical paths** — sheets.py, emailer.py, scheduler.py have no tests. All Google API interaction is untested.
3. **No deployment artifacts** — no .env, no OAuth tokens, no cron. Can't run without manual setup.

### P2 — Should Fix

4. **Unused dependencies** — APScheduler and rich are listed but never imported. Dead weight.
5. **README is stale** — References `utils.py` and `test_sheets.py` which don't exist. Project structure section doesn't match reality.
6. **Make.com blueprint contains real email addresses** — `email_autoresponder.json` has `nick@leftclick.ai` and `nick@1secondcopy.com` hardcoded. If this goes public, those are exposed.
7. **DECISIONS.md is empty** — Only scaffolding boilerplate, no actual decisions recorded.
8. **pandas is heavy for what it does** — Used only in `sheets.py` to process spreadsheet rows into Invoice objects. A simple list comprehension would work.

### P3 — Minor

9. **`__pycache__` committed** — `src/invoice_collector/__pycache__/` and `tests/__pycache__/` should be in `.gitignore` (they are, but the directories were committed before gitignore was added).
10. **Template test is conditional** — `test_all_stage_templates_exist` wraps its assertions in `if template_file.exists()`, so it passes silently if templates are missing.
11. **Business hours check is a warning only** — `is_within_business_hours()` logs a warning but doesn't prevent execution. Unclear if this is intentional or a TODO.

---

## What Works Well

- **Clean separation of concerns** — router.py is pure logic, emailer.py handles API, scheduler.py orchestrates
- **Retry logic with exponential backoff** — both Sheets and Gmail have proper 429 handling
- **DRY_RUN mode** — defaults to true, safe by design
- **Template system** — simple `{{variable}}` substitution, easy to customize
- **Error tracking** — `ErrorType` enum + `ProcessingError` dataclass gives structured error reporting
- **Draft-only design** — human stays in the loop, can't accidentally blast emails
- **Stage routing logic** — well-tested, handles edge cases (not overdue enough, already sent today, prevent re-sends)

---

## Alternative Implementation

The `email_autoresponder.json` file is a Make.com blueprint for a no-code cloud-based version. It's a completely separate implementation path (trigger on email, not on spreadsheet data). The README positions this as "Option 2" for non-technical users. **This is not connected to the Python code at all.**

---

## Summary

Smart-invoice-workflow is a **well-designed prototype** that has never touched production. The routing logic is solid and well-tested. The Google API integration exists but is untested and unconfigured. The business concept is sound (invoice collection automation with human oversight).

**Before this can be useful, we need to decide:** Is this a product Erik wants to use for his own business, sell as a product, or sunset? That decision drives whether we invest in deployment, testing, and productization — or simplify it into something smaller.
